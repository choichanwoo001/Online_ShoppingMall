<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fast_campus_12.not_found.shop.mapper.NoticeDynamicQueryMapper">

    <!-- ResultMap -->
    <resultMap id="NoticeDto" type="com.fast_campus_12.not_found.shop.notice.dto.NoticeDto">
        <result property="id" column="NOTICE_ID"/>
        <result property="title" column="TITLE"/>
        <result property="content" column="CONTENT"/>
        <result property="writer" column="CREATED_BY"/>
        <result property="viewCount" column="VIEW_COUNT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="pinned" column="IS_PINNED"/>
    </resultMap>

    <!-- 공통 필터 fragment -->
    <sql id="baseNoticeFilter">
        FROM NOTICE
        WHERE IS_ACTIVE = 1
    </sql>

    <!-- 공지사항 목록 조회 -->
    <select id="findNoticeList" resultMap="NoticeDto">
        SELECT
        NOTICE_ID,
        TITLE,
        CONTENT,
        CREATED_BY,
        VIEW_COUNT,
        CREATED_AT,
        IS_PINNED
        <include refid="baseNoticeFilter"/>

        <!-- 정렬 -->
        <choose>
            <when test="request.sortBy != null">
                ORDER BY
                IS_PINNED DESC,
                <choose>
                    <when test="request.sortBy.name() == 'CREATED_AT'">
                        CREATED_AT
                    </when>
                    <when test="request.sortBy.name() == 'VIEW_COUNT'">
                        VIEW_COUNT
                    </when>
                    <otherwise>
                        CREATED_AT
                    </otherwise>
                </choose>
                <choose>
                    <when test="request.sort.name() == 'ASC'"> ASC</when>
                    <otherwise> DESC</otherwise>
                </choose>
            </when>
            <otherwise>
                ORDER BY IS_PINNED DESC, CREATED_AT DESC
            </otherwise>
        </choose>

        LIMIT #{request.limit} OFFSET #{request.offset}
    </select>

    <!-- 총 개수 조회 -->
    <select id="countNoticeList" resultType="int">
        SELECT COUNT(*)
        <include refid="baseNoticeFilter"/>
    </select>

</mapper>
