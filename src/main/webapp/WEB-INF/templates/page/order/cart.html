<div th:fragment="content">
    <h1 class="category_tit">ì¥ë°”êµ¬ë‹ˆ</h1>
    <p th:text="${cartId}">aa</p>
    <div class="cart-container">
        <div class="cart-content-wrapper">
            <div class="cart-items-section">
                <div th:each="item : ${cartItems}" class="cart-item" th:data-cart-item-id="${item.cartItemId}">
                    <div class="item-selection">
                        <input type="checkbox" class="item-checkbox">
                    </div>
                    <div class="item-image-area">
                        <img th:src="${item.imageUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="item-image">
                    </div>
                    <div class="item-details">
                        <div class="item-name-price">
                            <p class="item-name" th:text="${item.productName}">ìƒí’ˆëª…</p>
                            <p class="item-price">
                                <span class="original-price" th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + 'ì›'">ì›ë˜ ê°€ê²©</span>
                                <span class="discounted-price" th:text="${#numbers.formatInteger(item.discountPrice, 3, 'COMMA')} + 'ì›'">í• ì¸ê°€ê²©</span>
                            </p>
                        </div>
                        <p class="item-options" th:text="'[' + ${item.color} + '/' + ${item.size} + ']'">[ì˜µì…˜]</p>
                        <button class="option-change-button" id="showMyPopupBtn">ì˜µì…˜ë³€ê²½</button>
                        <div class="item-quantity-controls">
                            <button class="quantity-minus">-</button>
                            <input type="text" th:value="${item.quantity}" class="quantity-input">
                            <button class="quantity-plus">+</button>
                        </div>
                    </div>
                    <button class="item-delete-button">ì‚­ì œ</button>
                </div>
            </div>

            <div class="order-summary-section">
                <div class="summary-line">
                    <span class="summary-label">ìƒí’ˆ í•©ê³„ê¸ˆì•¡</span>
                    <span class="summary-value"><span th:text="${originalTotalAmount}"></span>ì›</span>
                </div>
                <div class="summary-line">
                    <span class="summary-label">ì´ í• ì¸ê¸ˆì•¡</span>
                    <span class="summary-value"><span th:text="${totalDiscountAmount}"></span>ì›</span>
                </div>
                <div class="summary-line">
                    <span class="summary-label">ë°°ì†¡ë¹„</span>
                    <span class="summary-value">0ì›</span>
                </div>
                <div class="summary-total-line">
                    <span class="summary-label">ì´ ì£¼ë¬¸ í•©ê³„</span>
                    <span class="summary-total-value"><span th:text="${totalAmount}"></span>ì›ì›</span>
                </div>
                <button class="order-button full-order">ì „ì²´ìƒí’ˆì£¼ë¬¸</button>
                <button class="order-button selected-order">ì„ íƒìƒí’ˆì£¼ë¬¸</button>
            </div>
        </div>

        <div class="bottom-selection-actions">
            <button class="btn-secondary">ì „ì²´ì„ íƒ</button>
            <button class="btn-secondary" id="item-delete-button">ì„ íƒì‚­ì œ</button>
        </div>
    </div>
    <script>
        // DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        const openCartPopupBtn = document.getElementById('showMyPopupBtn');

        if (openCartPopupBtn) {
            openCartPopupBtn.addEventListener('click', () => {
                // alert('alert from cart.html inline script!'); // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ alert
                window.openCommonPopup('commonModalPopup');
            });
        }
        $(document).ready(function(){
            // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•´ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œì—ë„ ì´ë²¤íŠ¸ ì ìš©
            $(document).on('click', '.item-delete-button', function() {
                deleteSelectedItems();
                console.log("ì„ íƒ ë²„íŠ¼ í´ë¦­");
            });
        });
        // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë¡œë“œ
        function loadCartItems() {
            console.log("ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë¡œë“œ ì‹œì‘");

            $.get('/order/cart/items', function(response) {
                console.log('ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ì‘ë‹µ:', response);

                if (!response || response.length === 0) {
                    renderEmptyCart('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                } else {
                    renderCartItems(response);
                    loadCartSummary();
                }
            }).fail(function(xhr, status, error) {
                console.error('âŒ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                renderEmptyCart('ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // í•„ìˆ˜ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function loadCartSummary() {
            $.get('/order/cart/summary', function(data) {
                updateCartSummary(
                    data.totalItemCount,
                    data.totalAmount,
                    data.originalTotalAmount,
                    data.totalDiscountAmount
                );
            });
        }

        function deleteSelectedItems() {
            console.log("deleteSelectedItems í•¨ìˆ˜ ì‹¤í–‰");

            const selectedItems = $('.item-checkbox:checked');
            console.log("ì„ íƒëœ ì•„ì´í…œ ìˆ˜:", selectedItems.length);

            if (selectedItems.length === 0) {
                alert('ì‚­ì œí•  ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedCount = selectedItems.length;
            if (!confirm(`ì„ íƒí•œ ${selectedCount}ê°œ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // ì„ íƒëœ ì•„ì´í…œë“¤ì˜ ID ìˆ˜ì§‘
            const cartItemIds = [];
            selectedItems.each(function() {
                const cartItem = $(this).closest('.cart-item');
                const cartItemId = cartItem.data('cart-item-id');
                console.log("HTMLì—ì„œ ì°¾ì€ cartItemId:", cartItemId);

                if (cartItemId) {
                    cartItemIds.push(cartItemId);
                }
            });

            console.log("ì‚­ì œí•  ì•„ì´í…œ IDs:", cartItemIds);

            if (cartItemIds.length === 0) {
                alert('ì‚­ì œí•  ìƒí’ˆì˜ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            deleteItemsAndRerender(cartItemIds);
        }
        // ì•„ì´í…œë“¤ ì‚­ì œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        function deleteItemsAndRerender(cartItemIds) {
            let completedRequests = 0;
            let hasError = false;

            cartItemIds.forEach(cartItemId => {
                $.ajax({
                    url: `/order/cart/items/${cartItemId}`,
                    type: 'DELETE',
                    success: function (response) {
                        completedRequests++;

                        if (response.success) {
                            console.log(`âœ… ì•„ì´í…œ ì‚­ì œ ì„±ê³µ: ${cartItemId}`);
                        } else {
                            console.error('âŒ ì•„ì´í…œ ì‚­ì œ ì‹¤íŒ¨:', response.message);
                            hasError = true;
                        }

                        if (completedRequests === cartItemIds.length) {

                            if (hasError) {
                                alert('ì¼ë¶€ ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            } else {
                                alert('ì„ íƒí•œ ìƒí’ˆë“¤ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }

                            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìµœì‹  ìƒíƒœ ë°˜ì˜
                            //location.reload();
                        }
                    },
                    error: function (xhr, status, error) {
                        completedRequests++;
                        hasError = true;
                        console.error('âŒ ì•„ì´í…œ ì‚­ì œ ì‹¤íŒ¨:', error);

                        // ì„œë²„ ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            console.error('- ì„œë²„ ì—ëŸ¬ ì‘ë‹µ:', errorResponse);
                            alert(`ì‚­ì œ ì‹¤íŒ¨: ${errorResponse.message || error}`);
                        } catch (parseError) {
                            console.error('- JSON íŒŒì‹± ì‹¤íŒ¨, ì›ë³¸ ì‘ë‹µ:', xhr.responseText);
                            alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error} (HTTP ${xhr.status})`);
                        }

                        if (completedRequests === cartItemIds.length) {
                            // location.reload(); // ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬
                        }

                        if (completedRequests === cartItemIds.length) {
                            alert('ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            //location.reload();
                        }
                    }
                });
            });
        }
        function updateCartSummary(totalCount, totalAmount, originalAmount, discountAmount) {
            $('#totalItemCount').text(totalCount);
            $('#totalAmount').text(totalAmount.toLocaleString());
            $('#originalTotalAmount').text(originalAmount.toLocaleString());
            $('#totalDiscountAmount').text(discountAmount.toLocaleString());
        }

        function renderEmptyCart(message) {
            const container = $('#cart-items-container');
            container.html(`
            <div class="empty-cart">
                <div class="empty-cart-icon">ğŸ›’</div>
                <h3 class="empty-cart-title">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h3>
                <p class="empty-cart-message">${message || 'ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ë‹´ì•„ë³´ì„¸ìš”!'}</p>
                <a href="/products" class="btn-shopping">ì‡¼í•‘ ê³„ì†í•˜ê¸°</a>
            </div>
        `);
            updateCartSummary(0, 0, 0, 0);
        }

        function updateSelectAllState() {
            const totalItems = $('.item-checkbox').length;
            const checkedItems = $('.item-checkbox:checked').length;
            $('#selectAll').prop('checked', totalItems > 0 && checkedItems === totalItems);
        }

        function updateDeleteButtonState() {
            const checkedItems = $('.item-checkbox:checked').length;
            const deleteButton = $('.item-delete-button');

            if (checkedItems > 0) {
                deleteButton.text(`ì„ íƒ ì‚­ì œ (${checkedItems})`);
                deleteButton.prop('disabled', false);
                deleteButton.removeClass('disabled');
            } else {
                deleteButton.text('ì‚­ì œ');
                deleteButton.prop('disabled', false); // ë¹„í™œì„±í™”í•˜ì§€ ì•ŠìŒ
            }
        }

    </script>
</div>
