<div th:fragment="content">

    <meta charset="UTF-8"/>
    <h1 class="category_tit">주문/결제</h1>

    <div id="alertMessage" class="alert"></div>
    <div class="order-form-container">
    <form action="/order/order" method="post" id="orderForm">
        <section>
            <!-- 주문자 -->
            <div class="form-group">
                <label>주문자 *</label>
                <input type="text" name="name" id="name" th:value="${userDetail.name}" placeholder="이름 입력">
                <div class="error-message" id="nameError">이름을 입력해주세요.</div>
            </div>

            <!-- 이메일 -->
            <div class="form-group">
                <label>이메일 *</label>
                <div class="inline-group">
                    <input type="text" name="emailId" id="emailId" th:value="${emailId}" placeholder="아이디">
                    <span style="align-self: center;">@</span>
                    <input type="text" list="emailDomainOptions" name="emailDomain" id="emailDomain" th:value="${emailDomain}" placeholder="도메인 선택 또는 직접입력">
                    <datalist id="emailDomainOptions">
                        <option value="naver.com">
                        <option value="gmail.com">
                        <option value="hanmail.net">
                        <option value="daum.net">
                        <option value="hotmail.com">
                        <option value="korea.com">
                    </datalist>
                </div>
                <div class="error-message" id="emailError">올바른 이메일 형식을 입력해주세요.</div>
            </div>

            <!-- 휴대전화 -->
            <div class="form-group">
                <label>휴대전화</label>
                <div class="inline-group">
                    <select name="firstPhoneNum" id="firstPhoneNum">
                        <option value="010">010</option>
                        <option value="011">011</option>
                        <option value="017">017</option>
                    </select>
                    <input type="text" name="midPhoneNum" id="midPhoneNum" th:value="${midPhoneNum}" placeholder="0000" maxlength="4">
                    <input type="text" name="lastPhoneNum" id="lastPhoneNum" th:value="${lastPhoneNum}" placeholder="0000" maxlength="4">
                </div>
                <div class="error-message" id="phoneError">올바른 휴대전화 번호를 입력해주세요.</div>
            </div>

            <!-- 주소 -->
            <div class="form-group">
                <label>주소</label>
                <div class="address-search">
                    <input type="text" id="zipcode" name="zipcode" th:value="${address != null ? address.zipCode : ''}" placeholder="우편번호">
                    <button type="button" class="search-btn" onclick="execDaumPostcode()">주소검색</button>
                </div>
                <input type="text" id="address1" name="address1" th:value="${address != null ? address.roadAddress1 : ''}" placeholder="기본주소">
                <input type="text" id="address2" name="address2" th:value="${address != null ? address.roadAddress2 : ''}" placeholder="나머지 주소">
                <div class="error-message" id="addressError">주소를 입력해주세요.</div>
            </div>

            <label>
                <input type="checkbox" name="defaultAddress" value="true">
                기본 배송지로 저장
            </label>
        </section>

        <section class="order-item">
            <h3>주문상품</h3>
            <div id="orderItems">
                <div th:each="item, itemStat : ${snapShotDto}" class="item-row">
                    <span th:text="${item.title}">상품명</span>
                    <span th:text="${item.price} + '원'" th:data-price="${item.price}">가격</span>
                    <input type="number" name="items[__${itemStat.index}__].quantity" min="1" value="1" />
                    <input type="hidden" th:name="'items[' + ${itemStat.index} + '].price'" th:value="${item.price}">
                    <input type="hidden" th:name="'items[' + ${itemStat.index} + '].title'" th:value="${item.title}">
                </div>
            </div>
        </section>

        <section class="discount-info">
            <h3>할인/쿠폰/적립금</h3>

            <!-- 배송비 -->
            <div class="form-group">
                <label>배송비</label>
                <span id="shippingFeeDisplay" th:text="${shippingFee} + '원'"></span>
                <input type="hidden" id="shippingFee" th:value="${shippingFee}">
            </div>

            <!-- 적립금 -->
            <div class="form-group mileage-box">
                <label>적립금 사용</label>
                <div class="mileage-use">
                    <input type="number" name="useMileage" id="useMileage" min="0" step="100" value="0">
                    <button type="button" onclick="applyMileage()">사용</button>
                </div>
                <div class="mileage-info">
                    보유 적립금: <span id="availableMileage" th:text="${availableMileage}"></span>원
                </div>
                <div class="error-message" id="mileageError">보유 적립금을 초과할 수 없습니다.</div>
                <div class="success-message" id="mileageSuccess">적립금이 적용되었습니다.</div>
            </div>

            <!-- 가격 요약 -->
            <div class="price-summary">
                <div class="price-row">
                    <span>상품 총액:</span>
                    <span id="totalItemPrice">0원</span>
                </div>
                <div class="price-row">
                    <span>배송비:</span>
                    <span id="shippingFeePrice" th:text="${shippingFee} + '원'"></span>
                </div>
                <div class="price-row">
                    <span>적립금 사용:</span>
                    <span id="usedMileagePrice">-0원</span>
                </div>
                <div class="price-row total">
                    <span>최종 결제 금액:</span>
                    <span id="finalPrice" th:text="${lastFee} + '원'"></span>
                </div>
            </div>
        </section>

        <section>
            <div class="form-group">
                <label><strong>결제수단 선택 *</strong></label>
                <div class="payment-options">
                    <label>
                        <input type="radio" name="paymentMethod" value="CARD" checked>
                        카드결제
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="PHONE">
                        휴대폰결제
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="TRANSFER">
                        계좌이체
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="BANK">
                        무통장입금
                    </label>
                    <label>
                        <input type="radio" name="paymentMethod" value="EASY_PAY">
                        간편결제
                    </label>
                </div>
                <div class="error-message" id="paymentError">결제수단을 선택해주세요.</div>
            </div>
        </section>

        <section class="confirm-section">
            <div class="terms-agree">
                <label>
                    <input type="checkbox" name="agreeAll" id="agreeAll">
                    모든 약관에 동의합니다. *
                </label>
                <div class="error-message" id="agreeError">모든 약관에 동의해주세요.</div>
            </div>

            <div class="submit-box">
                <button type="button" class="submit-order" onclick="validateAndSubmit()">결제하기</button>
            </div>
        </section>
    </form>
    </div>


<!-- 다음 주소 API 스크립트 -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    // 전역 변수
    let originalAvailableMileage = 0;
    let currentUsedMileage = 0;
    let totalItemPrice = 0;
    let shippingFee = 0;

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        initializePrices();
        calculateTotalPrice();

        // 실시간 유효성 검사 이벤트 추가
        document.getElementById('name').addEventListener('blur', validateName);
        document.getElementById('emailId').addEventListener('blur', validateEmail);
        document.getElementById('emailDomain').addEventListener('blur', validateEmail);
        document.getElementById('midPhoneNum').addEventListener('blur', validatePhone);
        document.getElementById('lastPhoneNum').addEventListener('blur', validatePhone);
        document.getElementById('midPhoneNum').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        document.getElementById('lastPhoneNum').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        document.getElementById('agreeAll').addEventListener('change', validateAgreement);
    });

    // 가격 정보 초기화
    function initializePrices() {
        const availableMileageElement = document.getElementById('availableMileage');
        originalAvailableMileage = parseInt(availableMileageElement.textContent) || 0;

        const shippingFeeElement = document.getElementById('shippingFee');
        shippingFee = parseInt(shippingFeeElement.value) || 0;

        const itemPriceElements = document.querySelectorAll('[data-price]');
        totalItemPrice = 0;
        itemPriceElements.forEach(element => {
            totalItemPrice += parseInt(element.getAttribute('data-price')) || 0;
        });

        document.getElementById('totalItemPrice').textContent = totalItemPrice.toLocaleString() + '원';
    }

    // 다음 주소 API - 전역 함수 선언
    window.execDaumPostcode = function() {
        new daum.Postcode({
            oncomplete: function(data) {
                var fullAddr = data.address;
                var extraAddr = '';

                if (data.addressType === 'R') {
                    if (data.bname !== '') extraAddr += data.bname;
                    if (data.buildingName !== '') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if (extraAddr !== '') {
                        fullAddr += ' (' + extraAddr + ')';
                    }
                }

                document.getElementById('zipcode').value = data.zonecode;
                document.getElementById('address1').value = fullAddr;
                document.getElementById('address2').focus();

                clearError('zipcode');
                clearError('address1');
            }
        }).open();
    };

    // 적립금 사용 함수 - 전역 함수 선언
    window.applyMileage = function() {
        const useMileageInput = document.getElementById('useMileage');
        const inputMileage = parseInt(useMileageInput.value) || 0;

        if (inputMileage < 0) {
            showError('useMileage', 'mileageError', '적립금은 0원 이상 입력해주세요.');
            return;
        }

        if (inputMileage > originalAvailableMileage) {
            showError('useMileage', 'mileageError', '보유 적립금을 초과할 수 없습니다.');
            return;
        }

        if (inputMileage % 100 !== 0) {
            showError('useMileage', 'mileageError', '적립금은 100원 단위로 사용 가능합니다.');
            return;
        }

        currentUsedMileage = inputMileage;
        const remainingMileage = originalAvailableMileage - currentUsedMileage;

        document.getElementById('availableMileage').textContent = remainingMileage.toLocaleString();
        document.getElementById('usedMileagePrice').textContent = '-' + currentUsedMileage.toLocaleString() + '원';

        clearError('useMileage');
        showSuccess('mileageSuccess', '적립금이 적용되었습니다.');

        calculateTotalPrice();
    };

    // 총 가격 계산 함수
    function calculateTotalPrice() {
        const finalPrice = totalItemPrice + shippingFee - currentUsedMileage;
        document.getElementById('finalPrice').textContent = finalPrice.toLocaleString() + '원';
    }

    // 유효성 검사 함수들
    function validateName() {
        const name = document.getElementById('name').value.trim();
        if (name === '') {
            showError('name', 'nameError', '이름을 입력해주세요.');
            return false;
        }
        if (name.length < 2) {
            showError('name', 'nameError', '이름은 2자 이상 입력해주세요.');
            return false;
        }
        clearError('name');
        return true;
    }

    function validateEmail() {
        const emailId = document.getElementById('emailId').value.trim();
        const emailDomain = document.getElementById('emailDomain').value.trim();

        if (emailId === '' || emailDomain === '') {
            showError('emailId', 'emailError', '이메일을 완전히 입력해주세요.');
            showError('emailDomain', 'emailError', '');
            return false;
        }

        const emailRegex = /^[a-zA-Z0-9._-]+$/;
        if (!emailRegex.test(emailId)) {
            showError('emailId', 'emailError', '올바른 이메일 형식을 입력해주세요.');
            showError('emailDomain', 'emailError', '');
            return false;
        }

        const domainRegex = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!domainRegex.test(emailDomain)) {
            showError('emailDomain', 'emailError', '올바른 도메인을 입력해주세요.');
            showError('emailId', 'emailError', '');
            return false;
        }

        clearError('emailId');
        clearError('emailDomain');
        return true;
    }

    function validatePhone() {
        const midPhone = document.getElementById('midPhoneNum').value.trim();
        const lastPhone = document.getElementById('lastPhoneNum').value.trim();

        if (midPhone === '' && lastPhone === '') {
            clearError('midPhoneNum');
            clearError('lastPhoneNum');
            return true;
        }

        if (midPhone === '' || lastPhone === '') {
            showError('midPhoneNum', 'phoneError', '휴대전화 번호를 완전히 입력해주세요.');
            showError('lastPhoneNum', 'phoneError', '');
            return false;
        }

        const phoneRegex = /^\d{3,4}$/;
        if (!phoneRegex.test(midPhone) || !phoneRegex.test(lastPhone)) {
            showError('midPhoneNum', 'phoneError', '올바른 휴대전화 번호를 입력해주세요.');
            showError('lastPhoneNum', 'phoneError', '');
            return false;
        }

        clearError('midPhoneNum');
        clearError('lastPhoneNum');
        return true;
    }

    function validateAddress() {
        const zipcode = document.getElementById('zipcode').value.trim();
        const address1 = document.getElementById('address1').value.trim();

        if (zipcode === '' || address1 === '') {
            showError('zipcode', 'addressError', '주소를 입력해주세요.');
            showError('address1', 'addressError', '');
            return false;
        }

        clearError('zipcode');
        clearError('address1');
        return true;
    }

    function validatePaymentMethod() {
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!paymentMethod) {
            showError('', 'paymentError', '결제수단을 선택해주세요.');
            return false;
        }
        clearError('');
        return true;
    }

    function validateAgreement() {
        const agreeAll = document.getElementById('agreeAll').checked;
        if (!agreeAll) {
            showError('agreeAll', 'agreeError', '모든 약관에 동의해주세요.');
            return false;
        }
        clearError('agreeAll');
        return true;
    }

    // 전체 유효성 검사 및 제출 - 전역 함수 선언
    window.validateAndSubmit = function() {
        let isValid = true;

        isValid = validateName() && isValid;
        isValid = validateEmail() && isValid;
        isValid = validatePhone() && isValid;
        isValid = validateAddress() && isValid;
        isValid = validatePaymentMethod() && isValid;
        isValid = validateAgreement() && isValid;

        if (isValid) {
            showAlert('success', '주문이 완료되었습니다!');
            // 실제 제출하려면 아래 주석 해제
            // document.getElementById('orderForm').submit();
        } else {
            showAlert('danger', '입력 정보를 다시 확인해주세요.');
            const firstError = document.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    };

    // 에러 표시 함수
    function showError(inputId, errorId, message) {
        if (inputId) {
            const input = document.getElementById(inputId);
            input.classList.add('error');
        }

        const errorElement = document.getElementById(errorId);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    }

    // 에러 제거 함수
    function clearError(inputId) {
        if (inputId) {
            const input = document.getElementById(inputId);
            input.classList.remove('error');
        }
        // 에러 메시지는 숨기기 (추가)
        if (inputId) {
            // 에러 메시지가 inputId와 연결된 요소가 있을 경우 찾기
            // 여기선 특정 에러 아이디를 알 수 없으므로 예외처리 없이 두기
        }
    }

    // 성공 메시지 표시 함수
    function showSuccess(successId, message) {
        const successElement = document.getElementById(successId);
        if (successElement) {
            successElement.textContent = message;
            successElement.style.display = 'block';
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 3000);
        }
    }

    // 알림 메시지 표시 함수
    function showAlert(type, message) {
        const alertElement = document.getElementById('alertMessage');
        alertElement.className = `alert alert-${type}`;
        alertElement.textContent = message;
        alertElement.style.display = 'block';

        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 3000);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>


</div>